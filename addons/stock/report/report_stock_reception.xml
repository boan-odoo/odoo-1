<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="stock_reception_report_action" model="ir.actions.report">
        <field name="name">Reception Report</field>
        <field name="model">stock.picking</field>
        <field name="report_type">qweb-html</field>
        <field name="report_name">stock.report_reception</field>
    </record>

    <record id="stock_reception_action" model="ir.actions.client">
        <field name="name">Reception Report</field>
        <field name="tag">reception_report</field>
    </record>

    <template id="report_reception_body">
        <div class="o_report_reception justify-content-between">
            <div class="o_report_reception_header">
                <h3>
                    <t t-if="receipts">
                        <t t-foreach="receipts" t-as="receipt">
                            <div>
                                <a href="#" res-model="stock.picking" view-type="form" t-att-res-id="receipt.id">
                                    <t t-esc="receipt.display_name"/>
                                </a>
                                <t t-esc="receipt.state"/>
                            </div>
                        </t>
                        <button t-if="report_type == 'html' and any(not s['is_reserved'] and s['move_ins'] for source in sources_to_lines for s in sources_to_lines[source])"
                                class="btn btn-sm btn-primary o_report_reception_reserve o_reserve_all"
                                name="reserve_all_link">
                                Reserve All
                        </button>
                    </t>
                    <t t-else="">
                        No receipts selected or a non-incoming transfer selected
                    </t>
                </h3>
            </div>
            <div><table t-if="sources_to_lines" class="o_report_reception_table table table-bordered">
                <t t-foreach="sources_to_lines" t-as="source">
                    <thead>
                        <tr class="bg-light">
                            <th style="width: 1rem" t-if="report_type == 'html'"/>
                            <th>
                                <i t-if="source._name == 'stock.picking' and source.priority == '1'" class="o_priority o_priority_star fa fa-star"/>
                                <a name="source_link" href="#" t-att-res-model="source._name" view-type="form" t-att-res-id="source.id" t-esc="source.display_name"/>
                            </th>
                            <th>Expected Delivery <t t-esc="sources_to_formatted_scheduled_date[source]"/></th>
                            <th groups="uom.group_uom"/>
                            <th t-if="report_type == 'html' and any(s['move_ins'] for s in sources_to_lines[source])">
                                <button t-if="report_type == 'html' and any(not s['is_reserved'] for s in sources_to_lines[source])"
                                        class="btn btn-sm btn-primary o_report_reception_reserve o_reserve_all"
                                        name="reserve_source_link">
                                        Reserve All
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="possible_moves" t-value="sources_to_lines[source]"/>
                        <t t-foreach="possible_moves" t-as="line">
                            <tr>
                                <td t-if="report_type == 'html'">
                                    <button
                                        class="o_report_reception_forecasted btn btn-link fa fa-area-chart"
                                        t-attf-model="stock.move"
                                        t-att-move-id="line['move_out'].id"
                                        name="forecasted_report_link">
                                    </button>
                                </td>
                                <td>
                                    <t t-esc="line['product']['display_name']"/>
                                </td>
                                <td class="text-right"><t t-esc="line['quantity']"/></td>
                                <td groups="uom.group_uom"><t t-esc="line['uom']"/></td>
                                <td t-if="report_type == 'html' and not line['is_reserved'] and line['move_ins']">
                                    <button t-if="line['is_qty_available']"
                                        class="btn btn-sm btn-primary o_report_reception_reserve"
                                        t-attf-model="stock.move"
                                        t-att-move-id="line['move_out'].id"
                                        t-att-move-ins-ids="line['move_ins']"
                                        t-att-qty="line['quantity']"
                                        name="reserve_link">
                                        Reserve
                                    </button>
                                </td>
                                <td t-if="line['is_reserved'] and report_type == 'html'">
                                    <button
                                        class="btn btn-sm btn-primary o_report_reception_unreserve"
                                        t-attf-model="stock.move"
                                        t-att-move-id="line['move_out'].id"
                                        t-att-move-ins-ids="line['move_ins']"
                                        t-att-qty="line['quantity']"
                                        name="unreserve_link">
                                        Unreserve
                                    </button>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </t>
            </table>
            <p t-else="">
                No allocation need found for incoming products.
            </p></div>
        </div>
    </template>

    <template id="report_reception">
        <t t-call="web.html_container">
            <t t-if="report_type == 'pdf'" t-call="web.external_layout">
                <t t-call="stock.report_reception_body"/>
            </t>
            <t t-else="">
                <t t-call="stock.report_reception_body"/>
            </t>
        </t>
    </template>
</odoo>
