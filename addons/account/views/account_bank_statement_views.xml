<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record id="view_bank_statement_line_form" model="ir.ui.view">
            <field name="name">account.bank.statement.line.form</field>
            <field name="model">account.bank.statement.line</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="button_post" string="Confirm" type="object" class="oe_highlight"
                                attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                        <button name="button_draft" string="Reset To Draft" type="object" class="btn btn-secondary"
                                attrs="{'invisible': [('state', 'not in', ('posted', 'cancel'))]}"
                                groups="account.group_account_invoice"/>
                        <button name="button_cancel" string="Cancel" type="object"
                                attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,posted"/>
                    </header>
                    <sheet>
                        <!-- Invisible fields -->
                        <field name="suitable_journal_ids" invisible="1"/>
                        <field name="is_reconciled" invisible="1"/>
                        <field name="country_code" invisible="1"/>
                        <field name="posted_before" invisible="1"/>
                        <field name="company_id" invisible="1"/>
                        <field name="reconciled_move_ids" invisible="1"/>
                        <field name="reconciled_move_ids_count" invisible="1"/>

                        <div class="oe_button_box" id="button_box">

                            <button name="button_open_reconciled_moves"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-bars"
                                    attrs="{'invisible': [('reconciled_move_ids_count','=', 0)]}">
                                <field name="reconciled_move_ids_count"/>
                                <span attrs="{'invisible': [('reconciled_move_ids_count', '=', 0)]}">Journal Entries</span>
                                <span attrs="{'invisible': [('reconciled_move_ids_count', '!=', 0)]}">Journal Entry</span>
                            </button>

                        </div>

                        <div class="oe_title">
                            <h1 attrs="{'invisible': [('state', '!=', 'draft')]}"><span>Draft</span></h1>
                            <h1 attrs="{'invisible': [('state', '=', 'draft')]}"><field name="name" readonly="1"/></h1>
                        </div>

                        <group>
                            <group id="group1">
                                <field name="partner_id"
                                       context="{'default_is_company': True}"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>

                                <label for="amount"/>
                                <div class="o_row" id="journal_amount_div">

                                    <field name="amount"
                                           attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                    <field name="currency_id"
                                           options="{'no_create': True, 'no_open': True}"
                                           required="1"
                                           attrs="{'readonly': [('state', '!=', 'draft')]}"
                                           groups="base.group_multi_currency"/>

                                </div>

                                <label for="amount_currency"
                                       groups="base.group_multi_currency"/>
                                <div class="o_row" id="foreign_amount_div">

                                    <field name="amount_currency"
                                           attrs="{'readonly': [('state', '!=', 'draft')]}"
                                           groups="base.group_multi_currency"/>
                                    <field name="foreign_currency_id"
                                           options="{'no_create': True, 'no_open': True}"
                                           attrs="{'readonly': [('state', '!=', 'draft')]}"
                                           groups="base.group_multi_currency"/>

                                </div>

                                <field name="date"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                <field name="payment_ref"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            </group>
                            <group id="group2">
                                <field name="journal_id"
                                       domain="[('type', 'in', ('bank', 'cash'))]"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                <field name="partner_bank_id"
                                       context="{'default_partner_id': partner_id}"
                                       string="Customer Bank Account"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                <field name="statement_id"/>
                            </group>
                        </group>
                    </sheet>

                    <div class="o_attachment_preview"/>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" groups="base.group_user"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <record id="view_bank_statement_line_tree_transaction_mode" model="ir.ui.view">
            <field name="name">account.bank.statement.line.tree</field>
            <field name="model">account.bank.statement.line</field>
            <field name="arch" type="xml">
                <tree string="Bank Transactions">
                    <!-- Invisible fields -->
                    <field name="state" invisible="1"/>
                    <field name="company_id" invisible="1"/>
                    <field name="journal_id" invisible="1" />
                    <field name="is_reconciled" invisible="1"/>
                    <field name="partner_bank_id" invisible="1"/>
                    <field name="currency_id" invisible="1"/>

                    <!-- Displayed fields -->
                    <field name="statement_id" optional="hide"/>
                    <field name="running_balance_end"/>
                    <field name="move_id"/>
                    <field name="date"/>
                    <field name="payment_ref"/>
                    <field name="ref" optional="hidden"/>
                    <field name="partner_id"/>
                    <field name="amount"
                           sum="Amount"/>
                    <field name="amount_currency"
                           sum="Amount in Currency"
                           optional="hidden"
                           groups="base.group_multi_currency"/>
                    <field name="foreign_currency_id" optional="hidden" groups="base.group_multi_currency"/>
                    <field name="account_number" optional="hidden"/>
                    <field name="transaction_type" optional="hidden"/>
                    <field name="narration" optional="hidden"/>

                    <!-- Buttons -->
                    <button name="button_undo_reconciliation" type="object"
                            attrs="{'invisible': [('is_reconciled', '=', False)]}"
                            string="Revert reconciliation" icon="fa-undo"/>
                </tree>
            </field>
        </record>

        <record id="view_bank_statement_line_tree_statement_mode" model="ir.ui.view">
            <field name="name">account.bank.statement.line.tree</field>
            <field name="model">account.bank.statement.line</field>
            <field name="inherit_id" ref="account.view_bank_statement_line_tree_transaction_mode"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <tree position="inside">
                    <groupby name="statement_id">
                        <button name="edit" type="edit" icon="fa-edit" title="Edit"/>
                    </groupby>
                </tree>
            </field>
        </record>

        <record id="view_bank_statement_line_tree_transaction_mode_embedded" model="ir.ui.view">
            <field name="name">account.bank.statement.line.tree.embedded</field>
            <field name="model">account.bank.statement.line</field>
            <field name="inherit_id" ref="account.view_bank_statement_line_tree_transaction_mode"/>
            <field name="mode">primary</field>
            <field name="priority">99</field>
            <field name="arch" type="xml">
                <field name="statement_id" position="replace"/>
                <field name="running_balance_end" position="replace"/>
            </field>
        </record>

        <record id="view_bank_statement_line_search" model="ir.ui.view">
            <field name="name">account.bank.statement.line.search</field>
            <field name="model">account.bank.statement.line</field>
            <field name="arch" type="xml">
                <search string="Search Bank Statements Line">
                    <field name="payment_ref"/>
                    <field name="statement_id"/>
                    <field name="partner_id"/>
                    <field name="date"/>
                    <field name="journal_id" domain="[('type', 'in', ('bank', 'cash'))]" />
                    <field name="narration" string="Notes"/>
                    <field name="transaction_type"/>
                    <separator/>
                    <group expand="0" string="Group By">
                        <filter string="Bank Statement"
                                name="groupby_statement_id"
                                domain="[]"
                                context="{'group_by': 'statement_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="model_account_bank_statement_line_create_statement" model="ir.actions.server">
            <field name="name">Create Statement</field>
            <field name="model_id" ref="account.model_account_bank_statement_line"/>
            <field name="binding_model_id" ref="account.model_account_bank_statement_line"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">action = records.button_create_statement()</field>
        </record>

        <record id="model_account_bank_statement_line_set_journal_starting_balance" model="ir.actions.server">
            <field name="name">Set Starting Balance</field>
            <field name="model_id" ref="account.model_account_bank_statement_line"/>
            <field name="binding_model_id" ref="account.model_account_bank_statement_line"/>
            <field name="binding_view_types">list</field>
            <field name="state">code</field>
            <field name="code">action = records.button_set_journal_starting_balance()</field>
        </record>

        <record id="view_bank_statement_tree" model="ir.ui.view">
            <field name="name">account.bank.statement.tree</field>
            <field name="model">account.bank.statement</field>
            <field name="arch" type="xml">
                <tree decoration-danger="not has_valid_balances"
                      decoration-info="has_valid_balances"
                      string="Statements">
                    <!-- Invisible fields -->
                    <field name="has_valid_balances" invisible="1"/>

                    <field name="name"/>
                    <field name="date"/>
                    <field name="journal_id"/>
                    <field name="company_id" groups="base.group_multi_company"/>
                    <field name="balance_start"/>
                    <field name="balance_end"/>
                </tree>
            </field>
        </record>

        <record id="view_bank_statement_search" model="ir.ui.view">
            <field name="name">account.bank.statement.search</field>
            <field name="model">account.bank.statement</field>
            <field name="arch" type="xml">
                <search string="Search Bank Statements">
                    <field name="name" string="Bank Statement"/>
                    <field name="date"/>
                    <separator/>
                    <field name="journal_id" domain="[('type', 'in', ('bank', 'cash'))]"/>
                    <group expand="0" string="Group By">
                        <filter string="Journal" name="journal" context="{'group_by': 'journal_id'}"/>
                        <filter string="Date" name="date" context="{'group_by': 'date'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="view_bank_statement_form_transaction_mode" model="ir.ui.view">
            <field name="name">account.bank.statement.form</field>
            <field name="model">account.bank.statement</field>
            <field name="arch" type="xml">
                <form string="Bank Statement">
                    <header id="header"/>

                    <sheet>
                        <div class="oe_title oe_inline">
                            <label for="name"/>
                            <h1><field name="name" placeholder="e.g. BNK/2021/0001"/></h1>
                        </div>

                        <group>
                            <group>
                                <!-- Invisible fields -->
                                <field name="id" invisible="1"/>
                                <field name="currency_id" invisible="1"/>
                                <field name="nb_lines_to_reconcile" invisible="1"/>

                                <field name="journal_id"
                                       domain="[('type', 'in', ('bank', 'cash'))]"
                                       attrs="{'readonly': [('line_ids', '!=', [])]}"/>
                                <field name="date"
                                       options="{'datepicker': {'warn_future': true}}"/>
                                <field name='company_id'
                                       groups="base.group_multi_company"/>
                            </group>
                            <group>
                                <field name="balance_start"/>
                                <field name="balance_end_real"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Transactions" id="transactions_notebook">
                                <field name="line_ids"
                                       context="{'tree_view_ref': 'account.view_bank_statement_line_tree_transaction_mode_embedded'}"
                                       domain="['|', ('statement_id', '=', False), ('statement_id', '=', id)]"
                                       widget="many2many"/>
                            </page>
                        </notebook>

                        <group class="oe_subtotal_footer oe_right" colspan="2">
                            <div class="oe_subtotal_footer_separator oe_inline">
                                <label for="balance_end"/>
                            </div>
                            <field name="balance_end" nolabel="1" class="oe_subtotal_footer_separator"/>
                        </group>
                        <div class="oe_clear"/>

                    </sheet>

                    <div class="o_attachment_preview"/>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="message_ids"/>
                    </div>

                </form>
            </field>
        </record>

        <record id="view_bank_statement_form_statement_mode" model="ir.ui.view">
            <field name="name">account.bank.statement.form</field>
            <field name="model">account.bank.statement</field>
            <field name="inherit_id" ref="account.view_bank_statement_form_transaction_mode"/>
            <field name="mode">primary</field>
            <field name="arch" type="xml">
                <field name="line_ids" position="replace">
                    <field name="line_ids"
                           context="{'default_date': date, 'default_journal_id': journal_id}">
                        <tree string="Statement lines"
                              editable="bottom"
                              decoration-muted="is_reconciled"
                              limit="500">

                            <!-- Invisible fields -->
                            <field name="company_id" invisible="1"/>
                            <field name="state" invisible="1"/>
                            <field name="is_reconciled" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="partner_bank_id" invisible="1"/>
                            <field name="country_code" invisible="1"/>

                            <!-- Visible fields -->
                            <field name="sequence" widget="handle"/>
                            <field name="date"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="payment_ref"/>
                            <field name="partner_id"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"
                                   domain="['|', ('parent_id','=', False), ('is_company','=',True)]"/>
                            <field name="ref" optional="hidden"/>
                            <field name="transaction_type" optional="hidden"/>
                            <field name="narration" string="Notes" optional="hidden"/>
                            <field name="amount"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="amount_currency" optional="hidden" groups="base.group_multi_currency"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="account_number" optional="hidden"/>
                            <field name="foreign_currency_id" optional="hidden" groups="base.group_multi_currency"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"/>

                            <!-- Buttons -->
                            <button name="button_undo_reconciliation" type="object"
                                    attrs="{'invisible': [('is_reconciled', '=', False)], 'column_invisible': [('state', '!=', 'posted')]}"
                                    string="Revert reconciliation" icon="fa-undo"/>
                        </tree>
                    </field>
                </field>
            </field>
        </record>

        <record id="view_bank_statement_form_popup" model="ir.ui.view">
            <field name="name">account.bank.statement.form.popup</field>
            <field name="model">account.bank.statement</field>
            <field name="inherit_id" ref="account.view_bank_statement_form_transaction_mode"/>
            <field name="mode">primary</field>
            <field name="priority">99</field>
            <field name="arch" type="xml">
                <form position="inside">
                    <footer>
                        <button string="Save"
                                class="btn-primary"
                                special="save"/>
                        <button string="Discard"
                                class="btn-secondary"
                                special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <record id="action_bank_statement_tree" model="ir.actions.act_window">
            <field name="name">Bank Statements</field>
            <field name="res_model">account.bank.statement</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('journal_id.type', 'in', ('bank', 'cash'))]</field>
            <field name="context">{'journal_type': 'bank'}</field>
            <field name="search_view_id" ref="view_bank_statement_search"/>
            <field name="help" type="html">
              <p class="o_view_nocontent_smiling_face">
                Register a bank statement
              </p><p>
                A bank statement is a summary of all financial transactions
                occurring over a given period of time on a bank account. You
                should receive this periodically from your bank.
              </p><p>
                Odoo allows you to reconcile a statement line directly with
                the related sale or purchase invoices.
              </p>
            </field>
        </record>

    </data>
</odoo>
